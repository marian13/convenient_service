#!/usr/bin/env ruby
# frozen_string_literal: true

##
# @author Marian Kostyk <mariankostyk13895@gmail.com>
# @license LGPLv3 <https://www.gnu.org/licenses/lgpl-3.0.html>
##

#
# This file was generated by Bundler.
#
# The application 'yard-junk' is installed as part of a gem, and
# this file is here to facilitate running it.
#

ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../Gemfile", __dir__)

bundle_binstub = File.expand_path("bundle", __dir__)

if File.file?(bundle_binstub)
  if File.read(bundle_binstub, 300).include?("This file was generated by Bundler")
    load(bundle_binstub)
  else
    abort("Your `bin/bundle` was not generated by Bundler, so this binstub cannot run.
Replace `bin/bundle` by running `bundle binstubs bundler --force`, then run this command again.")
  end
end

require "rubygems"
require "bundler/setup"

##
# NOTE: `yard-junk` (actually `yard`) does NOT work with commonmarker v1+.
# - https://github.com/zverok/yard-junk/blob/v0.0.10/lib/yard-junk/janitor/resolver.rb#L37
#
# NOTE: Rubocop is disable to preserve original code styling.
# rubocop:disable all
require "yard-junk"

##
# TODO: Contribute.
# - https://github.com/lsegal/yard/commit/7b7a7d3762156aa92b96780e83980054ae11051a
# - https://github.com/lsegal/yard/blob/v0.9.38/lib/yard/templates/helpers/markup_helper.rb#L33
#
YARD::Templates::Helpers::MarkupHelper::MARKUP_PROVIDERS[:markdown] << {:lib => :commonmarker, :const => 'Commonmarker'}

##
# TODO: Contribute.
# - https://github.com/lsegal/yard/commit/7b7a7d3762156aa92b96780e83980054ae11051a
# - https://github.com/lsegal/yard/blob/v0.9.38/lib/yard/templates/helpers/html_helper.rb#L96
#
module YARD
  module Templates::Helpers
    module HtmlHelper
      def html_markup_markdown(text)
        # TODO: other libraries might be more complex
        provider = markup_class(:markdown)
        case provider.to_s
        when  'RDiscount'
          provider.new(text, :autolink).to_html
        when 'RedcarpetCompat'
          provider.new(text, :autolink,
                             :fenced_code,
                             :gh_blockcode,
                             :lax_spacing,
                             :tables,
                             :with_toc_data,
                             :no_intraemphasis).to_html
        when 'CommonMarker'
          CommonMarker.render_html(text, %i[DEFAULT GITHUB_PRE_LANG], %i[autolink table])
        when 'Commonmarker'
          ##
          # - https://github.com/gjtorikian/commonmarker?tab=readme-ov-file#render-options
          # - http://github.com/gjtorikian/commonmarker?tab=readme-ov-file#extension-options
          # - https://github.com/gjtorikian/commonmarker/tree/v0.23.12?tab=readme-ov-file#parse-options
          #
          Commonmarker.to_html(text,
            options: {
              render: {github_pre_lang: true},
              extension: {autolink: true, table: true}
            }
          )
        else
          provider.new(text).to_html
        end
      end
    end
  end
end
# rubocop:enable all

load Gem.bin_path("yard-junk", "yard-junk")
